# --- deps --------------------------------------------------------------------
# 解析系（dockerfile-utils/hadolint 等）が引っ掛からないよう、ARG は FROM の前に置く
ARG NODE_VERSION=20-alpine
# dockerfile-utils: ignore
FROM node:${NODE_VERSION} AS deps
WORKDIR /app
# 依存は package.json と lockfile だけを先にコピー（キャッシュ用）
COPY web/package.json web/package-lock.json ./
RUN npm ci

# --- build -------------------------------------------------------------------
FROM node:${NODE_VERSION} AS builder
WORKDIR /app
ENV NEXT_TELEMETRY_DISABLED=1
COPY --from=deps /app/node_modules ./node_modules
COPY web/ ./
# Next.js の本番ビルド
RUN npm run build

# --- run ---------------------------------------------------------------------
FROM node:${NODE_VERSION} AS runner
WORKDIR /app
ENV NODE_ENV=production
ENV NEXT_TELEMETRY_DISABLED=1
# ビルド成果物と必要ファイルをコピー
COPY --from=builder /app ./
EXPOSE 3000
# package.json の "start": "next start" を想定
CMD ["npm","start"]
